{
  "title": "理解 epoll()的实现",
  "cells": [
    {
      "type": "text",
      "data": "\n\t\t\n\t\n\t\n\t\t<div class=\"page\" title=\"Page 1\">\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 16.000000pt; font-family: 'WenQuanYiMicroHei'\"><br>\n</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">看官兄弟姐妹们，你们都点过</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">理解 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的实现</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的标题了，我想就不用再说 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">如果使用的废话云\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">云了。直接进入正题吧:\n</span><span style=\"font-size: 14.000000pt; font-family: 'DejaVuSans'; font-weight: 700; font-style: oblique\">epoll_create() </span><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">系统调用\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">首先，我们注意 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">返回的是一个文件描述符，这是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">与 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">select()/poll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">族系\n统调用的一点显著不同。有文件描述符就一定有对应的文件系统，这个特殊文件系统，在 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">RHEL5.4 </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">内核\n(主要基于 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">2.6.18</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，混合了部分 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">2.6.2x </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的代码)里叫 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">eventpollfs</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。不过，这个用来借壳</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">充数</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的文件\n系统在更新的内核里已经看不到了，因为新内核(至少 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">2.6.32 </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">以后是没有了)提供了更轻量级的方法实现\n</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">借壳</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">借壳</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">本身与 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的核心逻辑关系不大，我们略过不表。无论有没有这个特殊文件系统，这个打\n开文件的对应的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">file_operations </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">都实现了两个方法:一个是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">release</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，一个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">poll</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。前一个我不用介绍\n了，从名字上猜含义不难。后一个就比较有趣了，这意味着 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">返回文件描述符本身也是可以\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">select()/poll()/epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的，我们可以复合 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">!\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">创建完对应的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">inode()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">之后，就是做一些常规的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">VFS </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">粘合代码，诸如将 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">filp </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">与\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">fd </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">关联，不说了。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">另外，值得一提的，就是那个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">size </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">参数，其实是棒锤，什么也不顶。\n</span><span style=\"font-size: 14.000000pt; font-family: 'DejaVuSans'; font-weight: 700; font-style: oblique\">epoll_ctl() </span><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">系统调用\n</span></p>\n\t\t\t\t\t<pre><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">   前面做参数合法检查和退出时打扫战场的代码我就忽略了。这个函数的骨干逻辑如下:\n</span></pre>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epi = ep_find(ep, tfile, fd);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">error = -EINVAL;\nswitch (op) {<br>\ncase EPOLL_CTL_ADD:\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">if (!epi) {<br>\nepds.events |= POLLERR | POLLHUP;\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">error = ep_insert(ep, &amp;epds, tfile, fd);\n} else\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">error = -EEXIST;\nbreak;\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">case EPOLL_CTL_DEL:\nif (epi)\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">error = ep_remove(ep, epi);\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"page\" title=\"Page 2\">\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">else<br>\nerror = -ENOENT;\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">break;<br>\ncase EPOLL_CTL_MOD:\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">if (epi) {<br>\nepds.events |= POLLERR | POLLHUP;\nerror = ep_modify(ep, epi, &amp;epds);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">} else<br>\nerror = -ENOENT;\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">break;\n}\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">这是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_find()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">调用的唯一地方，它的作用是在在一棵红黑树查找满足已经添加过的</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">事件结构</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，\n毫无疑问，这是为 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">DEL </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">和 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">MOD </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">操作的预备动作。而我们将主要关心 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ADD</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，所以忽略它吧。此外一个值\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">得注意的地方，从以上代码可以看到，对于 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ADD</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">/</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">MOD </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">操作， </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">POLLERR | POLLHUP </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">都是必定\n会通知用户空间程序的，即使你不指定它们。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">OK</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，对于 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ADD </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">操作，就剩下 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_insert(ep, &amp;epds, tfile, fd) </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">需要解释了。这个函数首先\n分配一个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epi</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">event poll item</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)结构，然后初始化上面的几个链表什么的，没什么大不了是不是?但\n最关键的代码就隐藏在这个函数里面，其中最重要的代码是这么几行:\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">struct ep_pqueue epq;<br>\nepq.epi = epi;<br>\ninit_poll_funcptr(&amp;epq.pt, ep_ptable_queue_proc);\nrevents = tfile-&gt;f_op-&gt;poll(tfile, &amp;epq.pt);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">(当然，这个函数也会把 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epi </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">插入到之前提到的红黑树中。)\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">init_poll_funcptr()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">倒是很简单:只有一行代码，它的意思其实就是:\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epq.pt.qproc = ep_ptable_queue_proc;\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">稍微解释一下这里的数据结构， </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_pqueue </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">只是用来粘合 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">与 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Linux </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">多路复用\n(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">multiplexing</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">机制</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的一个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">脚手架</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epq.epi </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">脚</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">本</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">架</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">这一</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">端</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epq.pt </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Linux </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">多路复\n用(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">multiplexing</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">机制</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的另一</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">端</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_ptable_queue_proc</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，是一个函数，稍后介绍。</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tfile</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，是\n要需要</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">监听</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的那个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">fd </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的对应的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">filp</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">(内核里描述打开文件的结构</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">体</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)。这个结构</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">体</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">内的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">f_op-&gt;poll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">方\n法是实现 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Linux </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">多路复用(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">multiplexing</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">机制</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的关键点。因为</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">监听</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的文件可</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">能</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">socket</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，可</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">能</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是一\n个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">裸设</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">备，也可</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">能</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">某</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个文件，所以，只要想</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">支持</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">多路复用，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">协议栈、设</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">备</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">驱</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">动</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">、</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">文件系统都必</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">须支持</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">这个\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"page\" title=\"Page 3\">\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">方法。以 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">TCP </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">为</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">例</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，它的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">poll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">实现是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tcp_poll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">函数:\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">unsigned int tcp_poll(struct file *file, struct socket *sock, poll_table *wait)\n{\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">unsigned int mask;<br>\nstruct sock *sk = sock-&gt;sk;\nstruct tcp_sock *tp = tcp_sk(sk);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">poll_wait(file, sk-&gt;sk_sleep, wait);\nif (sk-&gt;sk_state == TCP_LISTEN)\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">return inet_csk_listen_poll(sk);\n/* ...... */\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">if ((tp-&gt;rcv_nxt != tp-&gt;copied_seq) &amp;&amp;\n(tp-&gt;urg_seq != tp-&gt;copied_seq ||\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tp-&gt;rcv_nxt != tp-&gt;copied_seq + 1 ||<br>\nsock_flag(sk, SOCK_URGINLINE) || !tp-&gt;urg_data))\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">mask |= POLLIN | POLLRDNORM;\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">/* ...... */\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">return mask;\n}\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">你可</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">能</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">注意到了，上面的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tcp_poll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">与 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tfile-&gt;f_op-&gt;poll()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的参数不同，这是因为 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tcp_poll()\n</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是通过 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">socket </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">层包装</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">过的，只是参数不同，但本</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">质</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">没有</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">区别</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。这个函数的代码</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">按功能</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">分</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">成</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">两部分，前面的\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">poll_wait()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">用于</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">支持</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">多路复用，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">file </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">和 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">wait </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">分</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">别</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是前面的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">tfile </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">和</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">&amp;epq.pt</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">sk-&gt;sk_sleep </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是<br>\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">TCP </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等待队列</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，如果 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">TCP </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">有需要通知的事件(</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">例</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">如</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">收</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">到数据</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">包</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">了)就通知在这个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等待队列</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">上面的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等待者;\n</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">后面是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">TCP </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">自己判断</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">否产生</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">了有</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">效</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">事件(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">POLLIN </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)的逻辑。</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">poll_wait()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的逻辑也是</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">非</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">常简单的，\n</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">相</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">当于:\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">if (&amp;epq.pt &amp;&amp; sk-&gt;sk_sleep)<br>\n&amp;epq.qt-&gt;qproc(tfile, sk-&gt;sk_sleep, &amp;epq.qt);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">也就是说，会调用 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_ptable_queue_proc()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，这个函数做了什么</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">呢</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">?</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">去掉错误处</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">理:\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">pwq = kmem_cache_alloc(pwq_cache, SLAB_KERNEL))) {\ninit_waitqueue_func_entry(&amp;pwq-&gt;wait, ep_poll_callback);\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"page\" title=\"Page 4\">\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">pwq-&gt;whead = whead;<br>\npwq-&gt;base = epi;\nadd_wait_queue(whead, &amp;pwq-&gt;wait);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">这是</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">啥</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">意思?其实意</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">图</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是很简单的，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">向 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">sk-&gt;sk_sleep </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">这个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等待队列</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">里</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">放置</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">一个</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等待者</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。通常意\n义上的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">唤醒等待者</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，会</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">唤醒</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">对应的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">某</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">任务</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，然后在下</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">次发生</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">中</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">断</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">时进行</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">任务切换</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。但这里的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">唤醒</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">只会</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">导致\n运</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">行 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_poll_callback</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，这个函数的核心代码是:\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">list_add_tail(&amp;epi-&gt;rdllink, &amp;ep-&gt;rdllist);\nif (waitqueue_active(&amp;ep-&gt;wq))\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">__wake_up_locked(&amp;ep-&gt;wq, TASK_UNINTERRUPTIBLE |\nTASK_INTERRUPTIBLE);\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">首先把这个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epi</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">event poll item</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)添加到这个事件</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">池</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">“</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Ready Event Linked List”</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">尾\n</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">部中，然后</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">唤醒等待</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">在这个事件</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">池</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">任务</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">(如果有的话)，也就是调用了 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_wait()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的用户空间</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">线</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">程。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 14.000000pt; font-family: 'DejaVuSans'; font-weight: 700; font-style: oblique\">epoll_wait() </span><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">系统调用\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">明白</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">了上述过程，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_wait()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">就</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">格</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">外简单了。首先，它</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">让</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">当前</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">线</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">程</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">休眠</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">在</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等待队列 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep-&gt;wq </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">上。\n直到因为</span><span style=\"font-size: 11.000000pt; font-family: 'DejaVuSans'\">”</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Ready Event Linked List“</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">里面有数据有个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">唤醒</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">它。然后，它会调用\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_events_transfer(ep, events, maxevents)</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">将</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">等</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">到的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">按顺</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">序事件复</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">制</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">到用户指定的参数中。这\n就不解释其</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">余</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的代码了。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">其</span><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">他 </span><span style=\"font-size: 14.000000pt; font-family: 'DejaVuSans'; font-weight: 700; font-style: oblique\">epoll_XXX() </span><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">系统调用\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">在 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">RHEL6 </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的内核(主要基于 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">2.6.32</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)里，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">还</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">有两个与 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">有关的系统调用:\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_pwait()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create1()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。这些只是上面</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">三</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个系统调用的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">包装</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">而已。</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">pwait </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是做了与进程</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">信\n号</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">有关的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">工</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">作，</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">create1 </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">则</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是用来</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">补漏</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 14.000000pt; font-family: 'DejaVuSans'; font-weight: 700; font-style: oblique\">epoll over epoll\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">上面</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">讲</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">到 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">返回的本身就是文件描述符，而 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">eventpollfs </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">则</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是一个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">支持</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">多路复用的\n特殊文件系统。这</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">样</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，我们就是可以对 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的结果做 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">了。为了</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">避免</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">可</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">能</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的无</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">穷递归</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的实现对此也做了</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">相</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">应的</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">处</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">理。这就是 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep-&gt;poll_wait </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">成员</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">和 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ep_poll_safewake()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">函数的用\n意所在了，这</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">块</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的代码就不粘了，点到即</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">止</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">吧。\n</span></p>\n\t\t\t\t\t<p><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">OK</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，为什么要 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll over epoll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">呢</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">?</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">试</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">想我们有几</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">千</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">socket </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">需要</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">处</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">理时，而我们不</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">希望平\n等</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">对</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">待</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">这几</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">千</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">socket</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，要将其分</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">成 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">128 </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">优</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">先级。上面已经看到，对于一个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">文件\n(</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll_create()</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">返回的那个 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">fd</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">)中的事件，内核是</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">平等</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">对</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">待</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的，就是一个简单的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">FIFO </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">队列</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。使用复\n合 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">epoll</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，就可以</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">快速</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">地分</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">辨</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">出</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">哪</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">些</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">优</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">先级上的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">socket </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">有数据</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">包</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">来</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">临</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，而不需要</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">逐</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">判断每</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">个就</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">绪连</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">接的\n</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">优</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">先级了，从而可以</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">优</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">先</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">处</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">理那</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">高优</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">先级的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">socket</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">嗯</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，再</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">改</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">吧</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">改</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">吧，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">似乎</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">是个很</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">好</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">QoS </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">机制</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的基</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">础</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">。\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"page\" title=\"Page 5\">\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 14.000000pt; font-family: 'WenQuanYiMicroHei'\">广告\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class=\"layoutArea\">\n\t\t\t\t<div class=\"column\">\n\t\t\t\t\t<p><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">借这个文</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">章</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">宣传</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">一下</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">自己</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">ctags/cscope </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">pyGTK GUI </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">前</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">端</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，开</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">发</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">中，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">吼吼~ 虽</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">然没有\n</span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Windows </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">上的 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Source Insight </span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">那么完</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">善</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">，但</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">总算</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">不用</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">太眼馋</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">了，也</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">够</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">用了，</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">整张 </span><span style=\"font-size: 12.000000pt; font-family: 'DejaVuSerif'\">Screenshot</span><span style=\"font-size: 11.000000pt; font-family: 'WenQuanYiMicroHei'\">:\n</span></p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<img src=\"quiver-image-url/7A7926ABCACDA2A92A6E6DF8F9F261B1.png\" alt=\"page5image1864\" width=\"498\" height=\"311\">\n\t\t</div>"
    }
  ]
}
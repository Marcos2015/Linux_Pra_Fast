{
  "title": "服务器端编程心得（一）—— 主线程与工作线程的分工",
  "cells": [
    {
      "type": "text",
      "data": "<article style=\"box-sizing: inherit; outline: 0px; position: relative; padding-top: 16px; color: rgb(51, 51, 51); font-family: &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div id=\"article_content\" class=\"article_content csdn-tracking-statistics\" data-pid=\"blog\" data-mod=\"popu_307\" data-dsm=\"post\" style=\"box-sizing: inherit; outline: 0px; padding: 0px; margin: 0px; word-break: break-all;\"><div class=\"htmledit_views\" style=\"box-sizing: inherit; outline: 0px; padding: 0px; margin: 0px; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; word-break: break-all;\"><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">&nbsp;服务器端为了能流畅处理多个客户端链接，一般在某个线程A里面accept新的客户端连接并生成新连接的socket fd，然后将这些新连接的socketfd给另外开的数个工作线程B1、B2、B3、B4，这些工作线程处理这些新连接上的网络IO事件（即收发数据），同时，还处理系统中的另外一些事务。这里我们将线程A称为主线程，B1、B2、B3、B4等称为工作线程。工作线程的代码框架一般如下：</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53033793#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53033793#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 446px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_1\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_1\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=1&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 446px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_4\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_4\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=4&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">while</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(!m_bQuit)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;epoll_or_select_func();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;handle_io_events();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;handle_other_things();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp; &nbsp; &nbsp; 在epoll_or_select_func()中通过select()或者poll/epoll()去检测socket fd上的io事件，若存在这些事件则下一步handle_io_events()来处理这些事件（收发数据），做完之后可能还要做一些系统其他的任务，即调用handle_other_things()。<p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">这样做有三个好处：</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">1. 线程A只需要处理新连接的到来即可，不用处理网络IO事件。由于网络IO事件处理一般相对比较慢，如果在线程A里面既处理新连接又处理网络IO，则可能由于线程忙于处理IO事件，而无法及时处理客户端的新连接，这是很不好的。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">2. 线程A接收的新连接，可以根据一定的负载均衡原则将新的socket fd分配给工作线程。常用的算法，比如round robin，即轮询机制，即，假设不考虑中途有连接断开的情况，一个新连接来了分配给B1，又来一个分配给B2，再来一个分配给B3，再来一个分配给B4。如此反复，也就是说线程A记录了各个工作线程上的socket fd数量，这样可以最大化地来平衡资源，避免一些工作线程“忙死”，另外一些工作线程“闲死”的现象。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">3. 即使工作线程不满载的情况下，也可以让工作线程做其他的事情。比如现在有四个工作线程，但只有三个连接。那么线程B4就可以在handle_other_thing()做一些其他事情。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">下面讨论一个很重要的效率问题：</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">&nbsp; &nbsp; &nbsp; 在上述while循环里面，epoll_or_selec_func()中的epoll_wait/poll/select等函数一般设置了一个超时时间。如果设置超时时间为0，那么在没有任何网络IO时间和其他任务处理的情况下，这些工作线程实际上会空转，白白地浪费cpu时间片。如果设置的超时时间大于0，在没有网络IO时间的情况，epoll_wait/poll/select仍然要挂起指定时间才能返回，导致handle_other_thing()不能及时执行，影响其他任务不能及时处理，也就是说其他任务一旦产生，其处理起来具有一定的延时性。这样也不好。那如何解决该问题呢？</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">&nbsp; &nbsp; &nbsp; 其实我们想达到的效果是，如果没有网络IO时间和其他任务要处理，那么这些工作线程最好直接挂起而不是空转；如果有其他任务要处理，这些工作线程要立刻能处理这些任务而不是在epoll_wait/poll/selec挂起指定时间后才开始处理这些任务。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">&nbsp; &nbsp; &nbsp; 我们采取如下方法来解决该问题，以linux为例，不管epoll_fd上有没有文件描述符fd，我们都给它绑定一个默认的fd，这个fd被称为唤醒fd。当我们需要处理其他任务的时候，向这个唤醒fd上随便写入1个字节的，这样这个fd立即就变成可读的了，epoll_wait()/poll()/select()函数立即被唤醒，并返回，接下来马上就能执行handle_other_thing()，其他任务得到处理。反之，没有其他任务也没有网络IO事件时，epoll_or_select_func()就挂在那里什么也不做。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">&nbsp; &nbsp; &nbsp;这个唤醒fd，在linux平台上可以通过以下几种方法实现：</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">1. 管道pipe，创建一个管道，将管道绑定到epoll_fd上。需要时，向管道一端写入一个字节，工作线程立即被唤醒。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">2. linux 2.6新增的eventfd：</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53033793#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53033793#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 1591px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_2\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_2\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=2&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 1591px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_5\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_5\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=5&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;eventfd(unsigned&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;initval,&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;flags);&nbsp;&nbsp;&nbsp;&nbsp;</span></span></li></ol></div>步骤也是一样，将生成的eventfd绑定到epoll_fd上。需要时，向这个eventfd上写入一个字节，工作线程立即被唤醒。<br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">3. 第三种方法最方便。即linux特有的socketpair，socketpair是一对相互连接的socket，相当于服务器端和客户端的两个端点，每一端都可以读写数据。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53033793#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53033793#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 1788px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_3\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_3\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=3&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 1788px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_6\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_6\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=6&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;socketpair(</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;domain,&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;type,&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;protocol,&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;sv[2]);&nbsp;&nbsp;</span></span></li></ol></div><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">调用这个函数返回的两个socket句柄就是sv[0]，和sv[1]，在一个其中任何一个写入字节，在另外一个收取字节。<p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">将收取的字节的socket绑定到epoll_fd上。需要时，向另外一个写入的socket上写入一个字节，工作线程立即被唤醒。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">如果是使用socketpair，那么domain参数一定要设置成AFX_UNIX。</p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all;\">&nbsp; &nbsp; &nbsp; 由于在windows，select函数只支持检测socket这一种fd，所以windows上一般只能用方法3的原理。而且需要手动创建两个socket，然后一个连接另外一个，将读取的那一段绑定到select的fd上去。这在写跨两个平台代码时，需要注意的地方。</p></div></div></article><div class=\"article-bar-bottom\" style=\"box-sizing: inherit; outline: 0px; padding: 0px 0px 16px; margin: 36px 0px 0px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(227, 227, 227); color: rgb(51, 51, 51); font-family: &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, sans-serif; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"article-copyright\" style=\"box-sizing: inherit; outline: 0px; padding: 0px; margin: 0px; font-size: 12px; color: rgb(153, 153, 153);\">版权声明：欢迎访问我的个人网站：http://www.hootina.org\thttps://blog.csdn.net/analogous_love/article/details/53033793</div></div>"
    }
  ]
}
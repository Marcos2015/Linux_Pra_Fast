{
  "title": "服务器端编程心得（三）—— 一个服务器程序的架构介绍",
  "cells": [
    {
      "type": "text",
      "data": "<p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">本文将介绍我曾经做过的一个项目的服务器架构和服务器编程的一些重要细节。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">一、程序运行环境</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">操作系统：centos 7.0</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">编译器：gcc/g++ 4.8.3 &nbsp; &nbsp; cmake 2.8.11</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">mysql数据库：5.5.47</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">项目代码管理工具：VS2013</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">一、程序结构</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">该程序总共有17个线程，其中分为9个数据库工作线程D和一个日志线程L，6个普通工作线程W，一个主线程M。（以下会用这些字母来代指这些线程）</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">（一）、数据库工作线程的用途</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">&nbsp;9个数据库工作线程在线程启动之初，与mysql建立连接，也就是说每个线程都与mysql保持一路连接，共9个数据库连接。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">&nbsp;每个数据库工作线程同时存在两个任务队列，第一个队列A存放需要执行数据库增删查改操作的任务sqlTask，第二个队列B存放sqlTask执行完成后的结果。sqlTask执行完成后立即放入结果队列中，因而结果队列中任务也是一个个的需要执行的任务。大致伪代码如下：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 934px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_1\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_1\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=1&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 934px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_11\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_11\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=11&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;db_thread_func()&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">while</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(!m_bExit)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(NULL&nbsp;!=&nbsp;(pTask&nbsp;=&nbsp;m_sqlTask.Pop()))&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//从m_sqlTask中取出的任务先执行完成后，pTask将携带结果数据</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pTask-&gt;Execute();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//得到结果后，立刻将该任务放入结果任务队列</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_resultTask.Push(pTask);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">continue</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(1000);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">现在的问题来了：</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">1. 任务队列A中的任务从何而来，目前只有消费者，没有生产者，那么生产者是谁？</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">2. 任务队列B中的任务将去何方，目前只有生产者没有消费者。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">这两个问题先放一会儿，等到后面我再来回答。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">（二）工作线程和主线程</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">在介绍主线程和工作线程具体做什么时，我们介绍下服务器编程中常常抽象出来的几个概念（这里以tcp连接为例）：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">1. &nbsp;TcpServer 即Tcp服务，服务器需要绑定ip地址和端口号，并在该端口号上侦听客户端的连接（往往由一个成员变量TcpListener来管理侦听细节）。所以一个TcpServer要做的就是这些工作。除此之外，每当有新连接到来时，TcpServer需要接收新连接，当多个新连接存在时，TcpServer需要有条不紊地管理这些连接：连接的建立、断开等，即产生和管理下文中说的TcpConnection对象。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">2.一个连接对应一个TcpConnection对象，TcpConnection对象管理着这个连接的一些信息：如连接状态、本端和对端的ip地址和端口号等。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">3.数据通道对象Channel，Channel记录了socket的句柄，因而是一个连接上执行数据收发的真正执行者，<span style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">Channel对象一般作为</span>TcpConnection的成员变量。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">4. TcpSession对象，是将Channel收取的数据进行解包，或者对准备好的数据进行装包，并传给Channel发送。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">归纳起来：一个TcpServer依靠TcpListener对新连接的侦听和处理，依靠TcpConnection对象对连接上的数据进行管理，TcpConnection实际依靠Channel对数据进行收发，依靠TcpSession对数据进行装包和解包。也就是说一个TcpServer存在一个TcpListener，对应多个TcpConnection，有几个TcpConnection就有几个TcpSession，同时也就有几个Channel。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">以上说的TcpServer、TcpListener、TcpConnection、Channel和TcpSession是服务器框架的网络层。一个好的网络框架，应该做到与业务代码脱耦。即上层代码只需要拿到数据，执行业务逻辑，而不用关注数据的收发和网络数据包的封包和解包以及网络状态的变化（比如网络断开与重连）。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">拿数据的发送来说：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">当业务逻辑将数据交给TcpSession，TcpSession将数据装好包后（装包过程后可以有一些加密或压缩操作），交给TcpConnection::SendData()，而TcpConnection::SendData()实际是调用Channel::SendData()，因为Channel含有socket句柄，所以Channel::SendData()真正调用send()/sendto()/write()方法将数据发出去。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">对于数据的接收，稍微有一点不同：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">通过select()/poll()/epoll()等IO multiplex技术，确定好了哪些TcpConnection上有数据到来后，激活该TcpConnection的Channel对象去调用recv()/recvfrom()/read()来收取数据。数据收到以后，将数据交由TcpSession来处理，最终交给业务层。注意数据收取、解包乃至交给业务层是一定要分开的。我的意思是：最好不要解包并交给业务层和数据收取的逻辑放在一起。因为数据收取是IO操作，而解包和交给业务层是逻辑计算操作。IO操作一般比逻辑计算要慢。到底如何安排要根据服务器业务来取舍，也就是说你要想好你的服务器程序的性能瓶颈在网络IO还是逻辑计算，即使是网络IO，也可以分为上行操作和下行操作，上行操作即客户端发数据给服务器，下行即服务器发数据给客户端。有时候数据上行少，下行大。（如游戏服务器，一个npc移动了位置，上行是该客户端通知服务器自己最新位置，而下行确是服务器要告诉在场的每个客户端）。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">在我的博文《<a href=\"http://blog.csdn.net/analogous_love/article/details/53033793\" target=\"_blank\" style=\"box-sizing: border-box; outline: 0px; color: rgb(102, 102, 102); text-decoration: none; cursor: pointer; word-break: break-all; font-family: &quot;Microsoft YaHei&quot;; line-height: 30px;\">服务器端编程心得（一）—— 主线程与工作线程的分工</a>》中介绍了，工作线程的流程：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 2661px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_2\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_2\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=2&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 2661px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_12\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_12\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=12&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">while</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(!m_bQuit)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;epoll_or_select_func();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;handle_io_events();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;handle_other_things();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">其中epoll_or_select_func()即是上文所说的通过select()/poll()/epoll()等IO multiplex技术，确定好了哪些TcpConnection上有数据到来。我的服务器代码中一般只会监测socket可读事件，而不会监测socket可写事件。至于如何发数据，文章后面会介绍。所以对于可读事件，以epoll为例，这里需要设置的标识位是：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">EPOLLIN 普通可读事件（当连接正常时，产生这个事件，recv()/read()函数返回收到的字节数；当连接关闭，这两个函数返回0，也就是说我们设置这个标识已经可以监测到新来数据和对端关闭事件）</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">EPOLLRDHUP 对端关闭事件（linux man手册上说这个事件可以监测对端关闭，但我实际调试时发送即使对端关闭也没触发这个事件，仍然是EPOLLIN，只不过此时调用recv()/read()函数，返回值会为0，所以实际项目中是否可以通过设置这个标识来监测对端关闭，仍然待考证）</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">EPOLLPRI 带外数据<br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">muduo里面将epoll_wait的超时事件设置为1毫秒，我的另一个项目将epoll_wait超时时间设置为10毫秒。这两个数值供大家参考。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">这个项目中，工作线程和主线程都是上文代码中的逻辑，主线程监听侦听socket上的可读事件，也就是监测是否有新连接来了。主线程和每个工作线程上都存在一个epollfd。如果新连接来了，则在主线程的handle_io_events()中接收新连接。产生的新连接的socket句柄挂接到哪个线程的epollfd上呢？这里采取的做法是round-robin算法，即存在一个对象CWorkerThreadManager记录了各个工作线程上工作状态。伪码大致如下：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 3368px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_3\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_3\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=3&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 3368px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_13\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_13\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=13&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;attach_new_fd(</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;newsocketfd)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;workerthread&nbsp;=&nbsp;get_next_worker_thread(next);&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;workerthread.attach_to_epollfd(newsocketfd);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;++next;&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(next&nbsp;&gt;&nbsp;max_worker_thread_num)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">即先从第一个工作线程的epollfd开始挂接新来socket，接着累加索引，这样下次就是第二个工作线程了。如果所以超出工作线程数目，则从第一个工作重新开始。这里解决了新连接socket“负载均衡”的问题。在实际代码中还有个需要注意的细节就是：epoll_wait的函数中的struct epoll_event 数量开始到底要设置多少个才合理？存在的顾虑是，多了浪费，少了不够用，我在曾经一个项目中直接用的是4096：</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 3719px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_4\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_4\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=4&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 3719px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_14\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_14\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=14&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">const</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;EPOLL_MAX_EVENTS&nbsp;=&nbsp;4096;&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">const</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;dwSelectTimeout&nbsp;=&nbsp;10000;&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">struct</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;epoll_event&nbsp;events[EPOLL_MAX_EVENTS];&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;nfds&nbsp;=&nbsp;epoll_wait(m_fdEpoll,&nbsp;events,&nbsp;EPOLL_MAX_EVENTS,&nbsp;dwSelectTimeout&nbsp;/&nbsp;1000);&nbsp;&nbsp;</span></span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">我在陈硕的muduo网络库中发现作者才用了一个比较好的思路，即动态扩张数量：开始是n个，当发现有事件的fd数量已经到达n个后，将struct epoll_event数量调整成2n个，下次如果还不够，则变成4n个，以此类推，作者巧妙地利用stl::vector在内存中的连续性来实现了这种思路：</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 3970px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_5\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_5\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=5&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 3970px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_15\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_15\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=15&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//初始化代码</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">std::vector&lt;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">struct</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;epoll_event&gt;&nbsp;events_(16);&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//线程循环里面的代码</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">while</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(m_bExit)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;numEvents&nbsp;=&nbsp;::epoll_wait(epollfd_,&nbsp;&amp;*events_.begin(),&nbsp;</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">static_cast</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&lt;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&gt;(events_.size()),&nbsp;1);&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(numEvents&nbsp;&gt;&nbsp;0)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">static_cast</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&lt;</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">size_t</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&gt;(numEvents)&nbsp;==&nbsp;events_.size())&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;events_.resize(events_.size()&nbsp;*&nbsp;2);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">读到这里，你可能觉得工作线程所做的工作也不过就是调用handle_io_events()来接收网络数据，其实不然，工作线程也可以做程序业务逻辑上的一些工作。也就是在handle_other_things()里面。那如何将这些工作加到handle_other_things()中去做呢？写一个队列，任务先放入队列，再让handle_other_things()从队列中取出来做？我在该项目中也借鉴了muduo库的做法。即handle_other_things()中调用一系列函数指针，伪码如下：</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 4475px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_6\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_6\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=6&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 4475px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_16\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_16\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=16&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;do_other_things()&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;somefunc();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//m_functors是一个stl::vector,其中每一个元素为一个函数指针</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;somefunc()&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">for</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">size_t</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;m_functors.size();&nbsp;++i)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_functors[i]();&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;m_functors.clear();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">当任务产生时，只要我们将执行任务的函数push_back到m_functors这个stl::vector对象中即可。但是问题来了，如果是其他线程产生的任务，两个线程同时操作m_functors，必然要加锁，这也会影响效率。muduo是这样做的：</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 4942px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_7\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_7\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=7&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 4942px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_17\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_17\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=17&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;add_task(</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">const</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;Functor&amp;&nbsp;cb)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;std::unique_lock&lt;std::mutex&gt;&nbsp;lock(mutex_);&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;m_functors.push_back(cb);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;do_task()&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;std::vector&lt;Functor&gt;&nbsp;functors;&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::unique_lock&lt;std::mutex&gt;&nbsp;lock(mutex_);&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;functors.swap(m_functors);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">for</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">size_t</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;functors.size();&nbsp;++i)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;functors[i]();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></p><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\">看到没有，利用一个栈变量functors将m_functors中的任务函数指针倒换（swap）过来了，这样大大减小了对m_functors操作时的加锁粒度。前后变化：变化前，相当于原来A给B多少东西，B消耗多少，A给的时候，B不能消耗；B消耗的时候A不能给。现在变成A将东西放到篮子里面去，B从篮子里面拿，B如果拿去一部分后，只有消耗完了才会来拿，或者A通知B去篮子里面拿，而B忙碌时，A是不会通知B来拿，这个时候A只管将东西放在篮子里面就可以了。</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 5533px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_8\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_8\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=8&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 5533px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_18\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_18\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=18&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">bool</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;bBusy&nbsp;=&nbsp;</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">false</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;add_task(</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">const</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;Functor&amp;&nbsp;cb)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;std::unique_lock&lt;std::mutex&gt;&nbsp;lock(mutex_);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;m_functors_.push_back(cb);&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//B不忙碌时只管往篮子里面加，不要通知B</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(!bBusy)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wakeup_to_do_task();&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">void</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;do_task()&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;bBusy&nbsp;=&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">true</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;std::vector&lt;Functor&gt;&nbsp;functors;&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::unique_lock&lt;std::mutex&gt;&nbsp;lock(mutex_);&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;functors.swap(pendingFunctors_);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">for</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(</span><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">size_t</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;functors.size();&nbsp;++i)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;functors[i]();&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;bBusy&nbsp;=&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">false</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">看，多巧妙的做法！</span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">因为每个工作线程都存在一个m_functors，现在问题来了，如何将产生的任务均衡地分配给每个工作线程。这个做法类似上文中如何将新连接的socket句柄挂载到工作线程的epollfd上，也是round-robin算法。上文已经描述，此处不再赘述。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">还有种情况，就是希望任务产生时，工作线程能够立马执行这些任务，而不是等epoll_wait超时返回之后。这个时候的做法，就是使用一些技巧唤醒epoll_wait，linux系统可以使用socketpair或timerevent、eventfd等技巧（这个细节在我的博文《<a href=\"http://blog.csdn.net/analogous_love/article/details/53033793\" target=\"_blank\" style=\"box-sizing: border-box; outline: 0px; color: rgb(102, 102, 102); text-decoration: none; cursor: pointer; word-break: break-all; font-family: &quot;Microsoft YaHei&quot;; line-height: 30px;\">服务器端编程心得（一）—— 主线程与工作线程的分工</a>》已经详细介绍过了）。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">上文中留下三个问题：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">1. 数据库线程任务队列A中的任务从何而来，目前只有消费者，没有生产者，那么生产者是谁？</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">2.数据库线程任务队列B中的任务将去何方，目前只有生产者没有消费者。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">3.业务层的数据如何发送出去？</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">问题1的答案是：业务层产生任务可能会交给数据库任务队列A，这里的业务层代码可能就是工作线程中do_other_things()函数执行体中的调用。至于交给这个9个数据库线程的哪一个的任务队列，同样采用了round-robin算法。所以就存在一个对象CDbThreadManager来管理这九个数据库线程。下面的伪码是向数据库工作线程中加入任务：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\"></span></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 6684px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_9\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_9\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=9&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 6684px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_19\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_19\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=19&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">bool</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;CDbThreadManager::AddTask(IMysqlTask*&nbsp;poTask&nbsp;)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(m_index&nbsp;&gt;=&nbsp;m_dwThreadsCount)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_index&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">return</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;m_aoMysqlThreads[m_index++].AddTask(poTask);&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">同理问题2中的消费者也可能就是do_other_things()函数执行体中的调用。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">现在来说问题3，业务层的数据产生后，经过TcpSession装包后，需要发送的话，产生任务丢给工作线程的do_other_things()，然后在相关的Channel里面发送，因为没有监测该socket上的可写事件，所以该数据可能调用send()或者write()时会阻塞，没关系，sleep()一会儿，继续发送，一直尝试，到数据发出去。伪码如下：</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><div class=\"dp-highlighter bg_cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 1px 0px 0px; margin: 0px 0px 24px; position: relative; overflow-y: hidden; overflow-x: auto; font-family: Consolas, &quot;Courier New&quot;, Courier, mono, serif; font-size: 12px; background-color: rgb(231, 229, 220); width: 843.469px; word-break: break-all; color: rgb(51, 51, 51); font-variant-ligatures: normal; orphans: 2; widows: 2;\"><div class=\"bar\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 0px 0px 45px; margin: 0px; word-break: break-all;\"><div class=\"tools\" style=\"box-sizing: border-box; outline: 0px; padding: 3px 8px 10px 10px; margin: 0px; word-break: break-all; font-variant-ligatures: normal; font-variant-east-asian: normal; font-variant-position: normal; font-stretch: normal; font-size: 9px; line-height: normal; font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; color: silver; background-color: rgb(248, 248, 248); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(108, 226, 108); border-right-width: 1px; border-right-style: solid; border-right-color: rgb(231, 229, 220);\"><b style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">[cpp]</b>&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"ViewSource\" title=\"view plain\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_plain.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">view plain</a><span data-mod=\"popu_168\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\">&nbsp;<a href=\"https://blog.csdn.net/analogous_love/article/details/53426777#\" class=\"CopyToClipboard\" title=\"copy\" style=\"box-sizing: border-box; outline: 0px; color: rgb(103, 149, 181); text-decoration: none; cursor: pointer; background-image: url(https://csdnimg.cn/release/phoenix/images/ico_copy.gif); border: none; padding: 1px; margin: 0px 10px 0px 0px; word-break: break-all; display: inline-block; width: 16px; height: 16px; text-indent: -2000px; background-position: left top; background-repeat: no-repeat no-repeat;\">copy</a><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 7119px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_10\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_10\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=10&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div><div style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px; word-break: break-all; position: absolute; left: 565px; top: 7119px; width: 16px; height: 16px; z-index: 99;\"><embed id=\"ZeroClipboardMovie_20\" src=\"https://csdnimg.cn/public/highlighter/ZeroClipboard.swf\" loop=\"false\" menu=\"false\" quality=\"best\" bgcolor=\"#ffffff\" width=\"16\" height=\"16\" name=\"ZeroClipboardMovie_20\" align=\"middle\" allowscriptaccess=\"always\" allowfullscreen=\"false\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" flashvars=\"id=20&amp;width=16&amp;height=16\" wmode=\"transparent\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></div></span><span data-mod=\"popu_169\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></div></div><ol start=\"1\" class=\"dp-cpp\" style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 24px; list-style-position: initial; list-style-image: initial; border-style: none solid none none; border-right-width: 1px; border-right-color: rgb(231, 229, 220); background-color: rgb(255, 255, 255); color: rgb(92, 92, 92); word-break: break-all;\"><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\"><span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">bool</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;Channel::Send()&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;offset&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">while</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">true</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"datatypes\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(46, 139, 87); font-weight: bold;\">int</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;n&nbsp;=&nbsp;::send(socketfd,&nbsp;buf&nbsp;+&nbsp;offset,&nbsp;length&nbsp;-&nbsp;offset);&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(n&nbsp;==&nbsp;-1)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(errno&nbsp;==&nbsp;EWOULDBLOCK)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::sleep(100);&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">continue</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"comment\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 130, 0);\">//对方关闭了socket，这端建议也关闭</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">else</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(n&nbsp;==&nbsp;0)&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close(socketfd);&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">return</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">false</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;+=&nbsp;n;&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">if</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;(offset&nbsp;&gt;=&nbsp;length)&nbsp;&nbsp;</span></span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">break</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;</span></li><li class=\"\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(248, 248, 248); color: rgb(92, 92, 92); line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">return</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">&nbsp;</span><span class=\"keyword\" style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: rgb(0, 102, 153); font-weight: bold;\">true</span><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></li><li class=\"alt\" style=\"box-sizing: border-box; outline: 0px; padding: 0px 3px 0px 10px !important; margin-top: 8px; margin-right: 0px !important; margin-bottom: 0px !important; margin-left: 40px; border-top: none; border-right: none; border-bottom: none; border-left: 3px solid rgb(108, 226, 108); border-image: initial; list-style-type: decimal; list-style-image: initial; background-color: rgb(255, 255, 255); color: inherit; line-height: 18px; list-style-position: outside !important; word-break: break-all;\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; margin: 0px; padding: 0px; border: none; color: black;\">}&nbsp;&nbsp;</span></li></ol></div><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span><span style=\"color: rgb(51, 51, 51); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-size: 14px; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></span><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">最后，还有一个日志线程没有介绍，高性能的日志实现方案目前并不常见。限于文章篇幅，下次再介绍。</span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\"><br style=\"box-sizing: border-box; outline: 0px; word-break: break-all;\"></span></p><p style=\"box-sizing: border-box; outline: 0px; padding: 0px; margin: 0px 0px 16px; font-size: 16px; color: rgb(79, 79, 79); line-height: 26px; text-align: justify; word-break: break-all; font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, SimHei, Arial, SimSun; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><span style=\"box-sizing: border-box; outline: 0px; word-break: break-all; font-size: 18px;\">zhangyl 2016.12.02晚12:35</span></p>"
    }
  ]
}
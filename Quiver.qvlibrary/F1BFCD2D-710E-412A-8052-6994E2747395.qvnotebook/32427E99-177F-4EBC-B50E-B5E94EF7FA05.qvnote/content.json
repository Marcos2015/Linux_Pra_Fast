{
  "title": "如何利用多核CPU来加速你的Linux命令 — awk, sed, bzip2, grep, wc等",
  "cells": [
    {
      "type": "text",
      "data": "<embed id=\"xunlei_com_thunder_helper_plugin_d462f475-c18e-46be-bd10-327458d045bd\" type=\"application/thunder_download_plugin\" height=\"0\" width=\"0\" style=\"color: rgb(0, 0, 0); font-family: Arial; font-size: 14px;\"><span style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em;\">你是否曾经有过要计算一个非常大的数据(几百GB)的需求？或在里面搜索，或其它操作——一些无法并行的操作。数据专家们，我是在对你们说。你可能有一个4核或更多核的CPU，但我们合适的工具，例如&nbsp;</span><strong style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">grep</strong><span style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em;\">,&nbsp;</span><strong style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">bzip2</strong><span style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em;\">,&nbsp;</span><strong style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">wc</strong><span style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em;\">,&nbsp;</span><strong style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">awk</strong><span style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em;\">,&nbsp;</span><strong style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">sed</strong><span style=\"color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px; line-height: 1.8em; text-indent: 2em;\">等等，都是单线程的，只能使用一个CPU内核。</span><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">借用卡通人物Cartman的话，“如何我能使用这些内核”?</p><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">要想让Linux命令使用所有的CPU内核，我们需要用到<a title=\"GNU Parallel\" href=\"https://www.gnu.org/software/parallel/\" target=\"_blank\" style=\"border: 0px; margin: 0px; padding: 0px; vertical-align: baseline; color: rgb(1, 141, 142); text-decoration: none;\">GNU Parallel</a>命令，它让我们所有的CPU内核在单机内做神奇的map-reduce操作，当然，这还要借助很少用到的<strong style=\"border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">–pipes&nbsp;</strong>参数(也叫做<strong style=\"border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">–spreadstdin</strong>)。这样，你的负载就会平均分配到各CPU上，真的。</p><h3 style=\"color: rgb(0, 0, 0); border: 0px; margin: 0px 0px 20px; padding: 0px; vertical-align: baseline; clear: left; font-size: 18px; line-height: 1.5em; font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif;\">BZIP2</h3><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">bzip2是比gzip更好的压缩工具，但它很慢！别折腾了，我们有办法解决这问题。</p><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">以前的做法：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat bigfile.bin | bzip2 --best &gt; compressedfile.bz2</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">现在这样：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat bigfile.bin&nbsp;| parallel --pipe --recend '' -k bzip2 --best &gt; compressedfile.bz2</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">尤其是针对bzip2，GNU parallel在多核CPU上是超级的快。你一不留神，它就执行完成了。</p><h3 style=\"color: rgb(0, 0, 0); border: 0px; margin: 0px 0px 20px; padding: 0px; vertical-align: baseline; clear: left; font-size: 18px; line-height: 1.5em; font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif;\">GREP</h3><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">如果你有一个非常大的文本文件，以前你可能会这样：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">grep pattern bigfile.txt</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">现在你可以这样：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat bigfile.txt | parallel &nbsp;--pipe grep 'pattern'</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">或者这样：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat bigfile.txt | parallel --block 10M --pipe grep 'pattern'</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">这第二种用法使用了<strong style=\"border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">&nbsp;–block 10M</strong>参数，这是说每个内核处理1千万行——你可以用这个参数来调整每个CUP内核处理多少行数据。</p><h3 style=\"color: rgb(0, 0, 0); border: 0px; margin: 0px 0px 20px; padding: 0px; vertical-align: baseline; clear: left; font-size: 18px; line-height: 1.5em; font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif;\">AWK</h3><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">下面是一个用awk命令计算一个非常大的数据文件的例子。</p><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">常规用法：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat rands20M.txt | awk '{s+=$1} END {print s}'</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">现在这样：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat rands20M.txt | parallel --pipe awk \\'{s+=\\$1} END {print s}\\' | awk '{s+=$1} END {print s}'</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">这个有点复杂：parallel命令中的<strong style=\"border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;\">–pipe</strong>参数将cat输出分成多个块分派给awk调用，形成了很多子计算操作。这些子计算经过第二个管道进入了同一个awk命令，从而输出最终结果。第一个awk有三个反斜杠，这是GNU parallel调用awk的需要。</p><h3 style=\"color: rgb(0, 0, 0); border: 0px; margin: 0px 0px 20px; padding: 0px; vertical-align: baseline; clear: left; font-size: 18px; line-height: 1.5em; font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif;\">WC</h3><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">想要最快的速度计算一个文件的行数吗？</p><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">传统做法：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">wc -l bigfile.txt</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">现在你应该这样：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat bigfile.txt | parallel &nbsp;--pipe wc -l | awk '{s+=$1} END {print s}'</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">非常的巧妙，先使用parallel命令‘mapping’出大量的<code style=\"background-color: rgb(248, 248, 248); border: 1px solid rgb(221, 221, 221); margin-right: 2px; margin-left: 2px; padding: 0px 5px; vertical-align: baseline; white-space: nowrap; font-size: 13px;\">wc -l</code>调用，形成子计算，最后通过管道发送给awk进行汇总。</p><h3 style=\"color: rgb(0, 0, 0); border: 0px; margin: 0px 0px 20px; padding: 0px; vertical-align: baseline; clear: left; font-size: 18px; line-height: 1.5em; font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif;\">SED</h3><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">想在一个巨大的文件里使用sed命令做大量的替换操作吗？</p><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">常规做法：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">sed s^old^new^g bigfile.txt</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">现在你可以：</p><pre style=\"background-color: rgb(236, 236, 236); border: 0px; margin-top: 20px; margin-bottom: 24px; padding: 20px; vertical-align: baseline; color: rgb(102, 102, 102); line-height: 21px; overflow: auto; font-size: 15px; max-width: 530px;\">cat bigfile.txt | parallel --pipe sed s^old^new^g</pre><p style=\"border: 0px; margin: 0px 0px 24px; padding: 0px; vertical-align: baseline; line-height: 1.8em; text-indent: 2em; color: rgb(51, 51, 51); font-family: 'Microsoft YaHei', 微软雅黑, Lucida, Verdana, 'Hiragino Sans GB', STHeiti, 'WenQuanYi Micro Hei', SimSun, sans-serif, serif; font-size: 16px;\">…然后你可以使用管道把输出存储到指定的文件里。</p>"
    }
  ]
}